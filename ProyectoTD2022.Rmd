---
title: "Contaminación Acústica en el Barrio de Ruzafa"
subtitle: Proyecto Tratamiento de Datos 2022
author: "María Mañas Marín"
date:  "`r Sys.Date()`"

params:
  lang: ES
lang: "`r switch(params$lang, ES = 'es-ES', EN = 'en-US')`"

output:

  pdf_document:
    toc: yes
    toc_depth: 3

  html_document:
    echo: yes
    number_sections: yes
    theme: lumen 
    toc: yes

  html_notebook:
    echo: yes
    number_sections: yes
    toc: yes

language:
  label:
    fig: 'Figura '
    tab: 'Tabla '
    eq: 'Ecuación '
    thm: 'Teorema '
    lem: 'Lema '
    def: 'Definición '
    cor: 'Corolario '
    prp: 'Proposición '
    exm: 'Ejemplo '
    exr: 'Ejercicio '
    proof: 'Demostración. '
    remark: 'Nota: '
    solution: 'Solución. '
---

# Configuración del los bloques (*Chunks*)

Cada bloque tiene muchos parámetros que pueden ser configurados

**include** = **FALSE** evita que el código y los resultados aparezcan en el archivo terminado. R Markdown aún ejecuta el código en el fragmento y los resultados pueden ser utilizados por otros fragmentos.

**echo = FALSE** evita que el código, pero no los resultados, aparezcan en el archivo terminado. Esta es una manera útil de incrustar figuras.

**message = FALSE** evita que los mensajes generados por el código aparezcan en el archivo finalizado.

**warning = FALSE** evita que las advertencias generadas por el código aparezcan en el final.

**fig.cap = "..."** agrega un título a los resultados gráficos.

Se pueden especificicar opciones generales por defecto en *opts_chunk\$set*

Más opciones en el enlace [\<https://bookdown.org/yihui/rmarkdown/\>](https://bookdown.org/yihui/rmarkdown/){.uri}

```{r setup, cache = F, echo = F, message = F, warning = F, tidy = F}


# CONFIGURACIÓN GENERAL
library(knitr)
options(width = 100)

# Opciones generales de los chucks. Se utilizarán salvo cambios en el chunk
opts_chunk$set(echo=F, message = F, error = F, warning = F, comment = NA, fig.align = 'center', dpi = 200, tidy = F, cache.path = '.cache/', fig.path = './figura/')

# Opciones generales de dígitos cuando se incluyen tablas
#options(xtable.type = 'html')
knit_hooks$set(inline = function(x) {
  
  if(is.numeric(x)) {
    round(x, getOption('digits'))
  } else {
    paste(as.character(x), collapse = ', ')
  }
})
#knit_hooks$set(plot = knitr:::hook_plot_html)
```

# Instalación automática de paquetes

Especificar las librerías necesarias para ejecutar el código en la variable ***packages***. Si no está instaladas, se instalarán y cargarán (solo para aquellas que están en el repositorio <http://cran.rediris.es>)

El siguiente bloque, al no especificar opciones del *chunk* usa la configuración por defecto.

```{r}

# Especificamos las librerías necesarias en esta lista

packages = c("tidyverse","knitr", 'dplyr', 'tidyr', 'VIM', 'patchwork')

#use this function to check if each package is on the local machine
#if a package is installed, it will be loaded
#if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})

#verify they are loaded
search()

```

# Introducción

Se usan rutas especificas a la carpeta data, que es la carpeta donde se encuentra la informacion del proyecto en 14 ficheros diferentes en relación a la contaminación acústica del barrio de Ruzafa, para su posterior análisis y tratamiento.

# Información

**‘data/Sueca_Esq_Denia.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Sueca Esq. Denia

**‘data/Cadiz_16.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Cádiz, 16

**‘data/Cadiz_3.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Cádiz, 3

**‘data/Cuba_3.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Cuba, 3

**‘data/Sueca_2.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Sueca, 2

**‘data/Sueca_61.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Sueca, 61

**‘data/Sueca_32.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Sueca, 32

**‘data/Carles_Cervera_Chaflan_Reina_Donya_Maria.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Carles Cervera, Chaflán Reina Doña María

**‘data/Salvador_Abril_Chaflan_Maestro_Jose_Serrano.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Salvador Abril Chaflán Maestro José Serrano

**‘data/Vivons_Chaflan_Cadiz.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Vivons Chaflán Cádiz

**‘data/Carles_Cervera_34.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Carles Cervera, 34

**‘data/Puerto_Rico_21.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Puerto Rico, 21

**‘data/Doctor_Serrano_21.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle Doctor Serrano, 21

**‘data/General_Prim_Chaflan_Donoso_Cortes.csv’** : Datos diarios del sensor de ruido ubicado en el barrio de Ruzafa, en la calle General Prim Chaflán Donoso Cortés


# Apertura de ficheros

Abrimos los archivos y los cargamos

```{r, echo = TRUE, message = FALSE, warning = FALSE, tidy = FALSE}

Cadiz_3 <- read_csv("data/Cadiz_3.csv")
Cadiz_16 <- read_csv("data/Cadiz_16.csv")
Carles_Cervera_34 <- read_csv("data/Carles_Cervera_34.csv")
Carles_Cervera_Chaflan_Donya_Maria <- read_csv("data/Carles_Cervera_Chaflan_Reina_Donya_Maria.csv")
Cuba_3 <- read_csv("data/Cuba_3.csv")
Doctor_Serrano_21 <- read_csv("data/Doctor_Serrano_21.csv")
General_Prim_Chaflan_Donoso_Cortes <- read_csv("data/General_Prim_Chaflan_Donoso_Cortes.csv")
Puerto_Rico_21 <- read_csv("data/Puerto_Rico_21.csv")
Salvador_Abril_Chaflan_Jose_Serrano <- read_csv("data/Salvador_Abril_Chaflan_Maestro_Jose_Serrano.csv")
Sueca_2 <- read_csv("data/Sueca_2.csv")
Sueca_32 <- read_csv("data/Sueca_32.csv")
Sueca_61 <- read_csv("data/Sueca_61.csv")
Sueca_Esq_Denia <- read_csv("data/Sueca_Esq_Denia.csv")
Vivons_Chaflan_Cadiz <- read_csv("data/Vivons_Chaflan_Cadiz.csv")

```

# Preparacion de los datos

Todos los archivos leídos los pasamos a un formato tidy habiéndolos ordenado todos de la misma manera para posteriormente juntarlos todos en un mismo data frame y poder trabajar cómodamente con él.

Comenzamos creando una columna a cada data frame distinto que se guardará en la variable lugar, de manera que cuando las juntemos, la variable 'Place' tendrá la información de todas las tablas


```{r, echo = TRUE, message = FALSE, warning = FALSE, tidy = FALSE}

Cadiz_3$Place = "Cadiz 3"
Cadiz_16$Place = "Cadiz 16"
Carles_Cervera_34$Place = "Carles Cervera 34"
Carles_Cervera_Chaflan_Donya_Maria$Place = "Carles Cervera Chaflan"
Cuba_3$Place = "Cuba 3"
Doctor_Serrano_21$Place = "Doctor Serrano"
General_Prim_Chaflan_Donoso_Cortes$Place = "General Prim"
Puerto_Rico_21$Place = "Puerto Rico 21"
Salvador_Abril_Chaflan_Jose_Serrano$Place = "Salvador Abril"
Sueca_2$Place = "Sueca 2"
Sueca_32$Place = "Sueca 32"
Sueca_61$Place = "Sueca 61"
Sueca_Esq_Denia$Place = "Sueca esq Denia"
Vivons_Chaflan_Cadiz$Place = "Vivons Chaflan"

```

Forzamos que los diferentes ficheros esten en un formato tidy

```{r, echo = TRUE, message = FALSE, warning = FALSE, tidy = FALSE}
Cadiz_3 = Cadiz_3[c(1,12,2:11)]
Cadiz_3t = Cadiz_3 %>% gather(Ruido, Valor,8:length(Cadiz_3)-1)

Cadiz_16 = Cadiz_16[c(1,12,2:11)]
Cadiz_16t = Cadiz_16 %>% gather(Ruido, Valor,8:length(Cadiz_16)-1)

Carles_Cervera_34 = Carles_Cervera_34[c(1,12,2:11)]
Carles_Cervera_34t = Carles_Cervera_34 %>% gather(Ruido, Valor,
                                                  8:length(Carles_Cervera_34)-1)

Carles_Cervera_Chaflan_Donya_Maria = 
  Carles_Cervera_Chaflan_Donya_Maria[c(1,12,2:11)]
Carles_Cervera_Chaflan_Donya_Mariat = Carles_Cervera_Chaflan_Donya_Maria %>% 
  gather(Ruido, Valor,8:length(Carles_Cervera_Chaflan_Donya_Maria)-1)

Cuba_3 = Cuba_3[c(1,12,2:11)]
Cuba_3t = Cuba_3 %>% gather(Ruido, Valor,8:length(Cuba_3)-1)

Doctor_Serrano_21 = Doctor_Serrano_21[c(1,12,2:11)]
Doctor_Serrano_21t = Doctor_Serrano_21 %>% gather(Ruido, Valor,
                                                8:length(Doctor_Serrano_21)-1)

General_Prim_Chaflan_Donoso_Cortes = General_Prim_Chaflan_Donoso_Cortes[c(1,12,2:11)]
General_Prim_Chaflan_Donoso_Cortest = General_Prim_Chaflan_Donoso_Cortes %>% 
  gather(Ruido, Valor,8:length(General_Prim_Chaflan_Donoso_Cortes)-1)

Puerto_Rico_21 = Puerto_Rico_21[c(1,12,2:11)]
Puerto_Rico_21t = Puerto_Rico_21 %>% gather(Ruido, Valor,8:length(Puerto_Rico_21)-1)

Salvador_Abril_Chaflan_Jose_Serrano = 
  Salvador_Abril_Chaflan_Jose_Serrano[c(1,12,2:11)]
Salvador_Abril_Chaflan_Jose_Serranot = 
  Salvador_Abril_Chaflan_Jose_Serrano %>% 
  gather(Ruido, Valor,8:length(Salvador_Abril_Chaflan_Jose_Serrano)-1)

Sueca_2 = Sueca_2[c(1,12,2:11)]
Sueca_2t = Sueca_2 %>% gather(Ruido, Valor,8:length(Sueca_2)-1)

Sueca_32 = Sueca_32[c(1,12,2:11)]
Sueca_32t = Sueca_32 %>% gather(Ruido, Valor,8:length(Sueca_32)-1)

Sueca_61 = Sueca_61[c(1,12,2:11)]
Sueca_61t = Sueca_61 %>% gather(Ruido, Valor,8:length(Sueca_61)-1)

Sueca_Esq_Denia = Sueca_Esq_Denia[c(1,12,2:11)]
Sueca_Esq_Deniat = Sueca_Esq_Denia %>% gather(Ruido, 
                              Valor,8:length(Sueca_Esq_Denia)-1)

Vivons_Chaflan_Cadiz = Vivons_Chaflan_Cadiz[c(1,12,2:11)]
Vivons_Chaflan_Cadizt = 
  Vivons_Chaflan_Cadiz %>% gather(Ruido, Valor,8:length(Vivons_Chaflan_Cadiz)-1)
```

Fusionamos todos los dataframes para trabajar cómodamente con los datos.

```{r, echo = TRUE, message = FALSE, warning = FALSE, tidy = FALSE}
df <- rbind(Cadiz_3t, Cadiz_16t, Carles_Cervera_34t, 
            Carles_Cervera_Chaflan_Donya_Mariat, 
            Cuba_3t, Doctor_Serrano_21t, 
            General_Prim_Chaflan_Donoso_Cortest,
            Puerto_Rico_21t,Salvador_Abril_Chaflan_Jose_Serranot, 
            Sueca_2t, Sueca_32t, Sueca_61t, Sueca_Esq_Deniat, 
            Vivons_Chaflan_Cadizt)

head(df,5)
```
# Analisis Exploratorio

Realizamos un Analisis Exploratorio para echar un primer vistazo a nuestros datos y a partir de ahi, limpiar, transformar y modelar datos con el objetivo de extraer información, sugerir conclusiones y servir a otras etapas posteriores.

```{r, echo = TRUE, message = FALSE, warning = FALSE, tidy = FALSE}
glimpse(df)
```
```{r, echo = TRUE, message = FALSE, warning = FALSE, tidy = FALSE}
summary(df)
```
A simple vista observamos que hay columnas que no nos proporcionan información. Además, encontramos valores infinitos en la columna que indica el valor del nivel de ruido. En cuanto a la columna id, observamos que no es adecuada, tanto por los valores que va tomando, teniendo en cuenta que el número máximo debería corresponderse con el número máximo de registro, así como el tipo de dato en el que se encuentran.   

# Acondicionamiento de los datos

Realizamos las modificaciones necesarias para convertir nuestro df en un df TIDY; suponiendo la eliminación de algunas columnas no informativas y cambios en los nombres de las otras tantas que si que informan.

```{r, echo = TRUE, message = FALSE, warning = FALSE, tidy = FALSE}
# Comprobamos si hay información irrelevante
df %>% filter(fiwareServicePath != '/sonometros')
# Todos los valores son iguales
df %>% filter(entityType != 'NoiseLevelObserved')
# Todos los valores son iguales
df$entityId %>% unique()
# Encontramos un total de 14 valores distintos que indican el número distinto de 
# id de estaciones en las que se ha medido el ruido, que corresponden con el total 
# de las estaciones. Es por eso que podemos prescindir de esta variable: La variable 
# 'Place' discrimina de la misma manera, proporcionándonos la misma información
df$Ruido %>% unique()
# Encontramos un total de 5 tipos de Ruidos medidos distintos, correspondiendo con 
# los medidos durante el día, la tarde, la noche, un total de las anteriores y un 
# indicador del nivel sonoro continuo

# Las columnas _id, fiwareServicePath, recvTime, entityId y entityType no aportan 
# información.
df_tidy <- df %>% select(-1, -fiwareServicePath, -entityType, -recvTime, -entityId)

# Guardamos cada variable con el tipo de dato que le corresponde
df_tidy <- df_tidy %>% mutate(Place = as.factor(Place), 
                              dateObserved = as.POSIXlt(dateObserved), 
                              Ruido = as.factor(Ruido),
                              Valor = as.numeric(Valor))

# Modificamos el nombre de las variables
names(df_tidy) = c("Estacion", "Fecha_Medidas", "Tipo_Ruido", "Nivel_Sonoro")
```
Después de todos estos cambios, tenemos com resultado un dataset con las siguientes variables:

-**Estacion**, Lugar de medición\
-**Fecha_Medidas**, Fecha a la que se refieren las medidas\
-**Tipo_Ruido**, Tipo de ruido que se mide\
-**Nivel_Sonoro**, Valor del ruido que se mide\

Visualizamos de qué manera ha quedado nuestro conjunto de datos tras el tratamiento de sus filas y columnas

```{r, echo = TRUE, message = FALSE, warning = FALSE, tidy = FALSE}
head(df_tidy, 5)
```

# Detección y corrección de outliers

Realizamos un analisis de los valores perdidos, infinitos o inusuales de nuestro conjunto de datos

```{r, echo = TRUE, message = FALSE, warning = FALSE, tidy = FALSE}
# Comprobamos en qué posiciones encontramos valores 'Inf' - Infinitos y 
# los imputamos por la media de los valores posibles de 'Nivel_Sonoro'
# sin tener en cuenta las posiciones en las que encontramos inf
which(df_tidy$Nivel_Sonoro == Inf)
pos <- which(df_tidy$Nivel_Sonoro == Inf)
df_tidy$Nivel_Sonoro[pos] <- mean(df_tidy$Nivel_Sonoro[-pos])

# Comprobamos en qué posiciones encontramos valores 'NA' y obtenemos un total de 0
which(df_tidy$Nivel_Sonoro == NA)
# Visualizamos lo esperado
aggr(df_tidy, prop = FALSE, combined = TRUE, numbers = TRUE, sortVars = TRUE, sortCombs = TRUE)

```




